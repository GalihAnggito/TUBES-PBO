<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Confessly - Share Your Thoughts Anonymously</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #7158e2;
            --secondary-color: #3ae374;
            --dark-color: #3d3d3d;
            --light-color: #f7f7f7;
            --danger-color: #ff6b6b;
            --success-color: #1dd1a1;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f0f2f5;
            color: var(--dark-color);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* Header Styles */
        header {
            background-color: var(--primary-color);
            color: white;
            padding: 1rem 0;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.8rem;
            font-weight: bold;
            cursor: pointer;
        }

        .logo span {
            color: var(--secondary-color);
        }

        .auth-buttons {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.3s;
        }

        .btn-primary {
            background-color: var(--secondary-color);
            color: white;
        }

        .btn-secondary {
            background-color: transparent;
            color: white;
            border: 1px solid white;
        }

        .btn:hover {
            opacity: 0.9;
        }

        /* Hero Section */
        .hero {
            text-align: center;
            padding: 3rem 0;
            background: linear-gradient(135deg, var(--primary-color), #8e44ad);
            color: white;
            margin-bottom: 2rem;
        }

        .hero h1 {
            font-size: 2.5rem;
            margin-bottom: 1rem;
        }

        .hero p {
            font-size: 1.2rem;
            max-width: 600px;
            margin: 0 auto 2rem;
        }

        /* Main Content */
        .main-content {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        /* Menfess Posts */
        .menfess-container {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .menfess-header {
            padding: 1rem;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .menfess-header h2 {
            font-size: 1.5rem;
            color: var(--primary-color);
        }

        .filters {
            display: flex;
            gap: 10px;
        }

        .filter-item {
            padding: 5px 10px;
            border-radius: 20px;
            background-color: #f0f2f5;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background-color 0.3s;
        }

        .filter-item.active {
            background-color: var(--primary-color);
            color: white;
        }

        /* Individual Menfess Post */
        .menfess-list {
            padding: 1rem;
        }

        .menfess-post {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            padding: 1rem;
            margin-bottom: 1rem;
            border-left: 4px solid var(--primary-color);
        }

        .post-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            color: #777;
        }

        .post-content {
            margin-bottom: 1rem;
        }

        .post-actions {
            display: flex;
            gap: 15px;
            color: #777;
            font-size: 0.9rem;
        }

        .post-action {
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            transition: color 0.3s;
        }

        .post-action:hover {
            color: var(--primary-color);
        }

        .post-action.delete:hover {
            color: var(--danger-color);
        }

        .post-action.edit:hover {
            color: var(--primary-color);
        }

        .post-action i {
            font-size: 1.1rem;
        }

        .post-action.liked {
            color: var(--danger-color);
        }

        .post-action.liked i {
            color: var(--danger-color);
        }

        /* Comments */
        .comments-section {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #eee;
        }

        .comment {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 10px;
        }

        .comment-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.9rem;
            color: #777;
        }

        .comment-text {
            margin-bottom: 5px;
        }

        .comment-actions {
            display: flex;
            gap: 15px;
            color: #777;
            font-size: 0.9rem;
        }

        .comment-action {
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            transition: color 0.3s;
        }

        .comment-action:hover {
            color: var(--primary-color);
        }

        .comment-action.liked {
            color: var(--danger-color);
        }

        .comment-action.liked i {
            color: var(--danger-color);
        }

        .comment-action i {
            font-size: 1rem;
        }

        .comment-user {
            font-weight: 500;
            margin-right: 10px;
        }

        .comment-time {
            font-size: 0.8rem;
            color: #777;
            margin-top: 5px;
        }

        .comment-form {
            display: flex;
            margin-top: 1rem;
        }

        .comment-input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 20px;
            font-size: 0.9rem;
        }

        .comment-submit {
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 20px;
            padding: 0 15px;
            margin-left: 10px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .comment-submit:hover {
            background-color: #5e48c8;
        }

        /* Sidebar */
        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .sidebar-card {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .sidebar-header {
            background-color: var(--primary-color);
            color: white;
            padding: 1rem;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .sidebar-content {
            padding: 1rem;
        }

        /* New Menfess Form */
        .new-menfess-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .form-group label {
            font-weight: 500;
            font-size: 0.9rem;
        }

        .form-control {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
        }

        textarea.form-control {
            min-height: 120px;
            resize: vertical;
        }

        .form-group .help-text {
            font-size: 0.8rem;
            color: #777;
        }

        .anonymous-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 20px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: var(--primary-color);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(20px);
        }

        /* Rules Section */
        .rules-list {
            list-style-type: none;
        }

        .rules-list li {
            padding: 8px 0;
            display: flex;
            align-items: flex-start;
            gap: 10px;
            border-bottom: 1px solid #f0f2f5;
        }

        .rules-list li:last-child {
            border-bottom: none;
        }

        .rules-list i {
            color: var(--primary-color);
            margin-top: 3px;
        }

        /* Trending Topics */
        .trending-topics {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .topic-tag {
            padding: 5px 10px;
            background-color: #f0f2f5;
            border-radius: 20px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .topic-tag:hover {
            background-color: #e0e0e0;
        }

        /* Footer */
        footer {
            background-color: var(--dark-color);
            color: white;
            padding: 2rem 0;
            margin-top: 2rem;
        }

        .footer-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 2rem;
        }

        .footer-section h3 {
            font-size: 1.2rem;
            margin-bottom: 1rem;
            color: var(--secondary-color);
        }

        .footer-links {
            list-style: none;
        }

        .footer-links li {
            margin-bottom: 10px;
        }

        .footer-links a {
            color: #ddd;
            text-decoration: none;
            transition: color 0.3s;
        }

        .footer-links a:hover {
            color: var(--secondary-color);
        }

        .social-links {
            display: flex;
            gap: 15px;
            margin-top: 1rem;
        }

        .social-links a {
            color: white;
            background-color: rgba(255, 255, 255, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.3s;
        }

        .social-links a:hover {
            background-color: var(--primary-color);
        }

        .footer-bottom {
            margin-top: 2rem;
            text-align: center;
            padding-top: 1rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Modals */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 10px;
            width: 90%;
            max-width: 400px;
            position: relative;
        }

        .close-modal {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 1.5rem;
            cursor: pointer;
            color: #777;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--dark-color);
        }

        .form-group input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .modal-footer {
            margin-top: 1.5rem;
            text-align: center;
        }

        .modal-footer a {
            color: var(--primary-color);
            text-decoration: none;
            cursor: pointer;
        }

        .error-message {
            color: var(--danger-color);
            font-size: 0.9rem;
            margin-top: 0.5rem;
            display: none;
        }

        /* Responsive Design */
        @media (max-width: 900px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .header-container {
                flex-direction: column;
                gap: 10px;
            }
            
            .hero h1 {
                font-size: 2rem;
            }
            
            .hero p {
                font-size: 1rem;
            }
        }

        @media (max-width: 600px) {
            .filters {
                display: none;
            }
            
            .post-actions {
                flex-wrap: wrap;
            }
            
            .footer-content {
                grid-template-columns: 1fr;
            }
        }

        textarea#menfessContent {
            min-height: 70px;
            resize: vertical;
            border-radius: 8px;
            border: 1px solid #ddd;
            padding: 10px;
            font-size: 1rem;
            width: 100%;
            margin-bottom: 1rem;
            box-sizing: border-box;
        }

        #createMenfessBtn {
            background: #7158e2;
            color: #fff;
            border: none;
            border-radius: 8px;
            padding: 10px 0;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
            width: 100%;
        }

        #createMenfessBtn:hover {
            background: #5f4bd1;
        }

        .profile-menu {
            position: relative;
            display: inline-block;
        }

        .profile-button {
            display: flex;
            align-items: center;
            gap: 8px;
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 20px;
            transition: background-color 0.3s;
        }

        .profile-button:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .profile-picture {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            object-fit: cover;
            background-color: #666;
        }

        .profile-info {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .username {
            font-weight: 500;
        }

        .dropdown-arrow {
            font-size: 0.8rem;
        }

        .profile-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            min-width: 200px;
            display: none;
            z-index: 1000;
        }

        .profile-dropdown.show {
            display: block;
        }

        .profile-dropdown-item {
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--dark-color);
            text-decoration: none;
            transition: background-color 0.3s;
        }

        .profile-dropdown-item:hover {
            background-color: #f0f2f5;
        }

        .profile-dropdown-item i {
            width: 20px;
            color: var(--primary-color);
        }

        .profile-dropdown-divider {
            height: 1px;
            background-color: #eee;
            margin: 5px 0;
        }

        /* Alert Modal Styles */
        .alert-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .alert-content {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            max-width: 400px;
            width: 90%;
            text-align: center;
        }

        .alert-title {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 15px;
            color: var(--primary-color);
        }

        .alert-message {
            margin-bottom: 20px;
            color: var(--dark-color);
        }

        .alert-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
        }

        .alert-btn {
            padding: 8px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.3s;
        }

        .alert-btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .alert-btn-secondary {
            background-color: #e0e0e0;
            color: var(--dark-color);
        }

        .alert-btn:hover {
            opacity: 0.9;
        }

        /* Edit Modal */
        .edit-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .edit-modal-content {
            position: relative;
            background-color: white;
            margin: 15% auto;
            padding: 20px;
            width: 50%;
            max-width: 500px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .edit-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .edit-modal-header h3 {
            margin: 0;
            color: var(--primary-color);
        }

        .edit-modal-close {
            cursor: pointer;
            font-size: 1.5rem;
            color: #666;
        }

        .edit-modal-body textarea {
            width: 100%;
            min-height: 100px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 20px;
            resize: vertical;
        }

        .edit-modal-footer {
            text-align: right;
        }

        .edit-modal-footer button {
            padding: 8px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
        }

        .edit-modal-footer .cancel-btn {
            background-color: #f0f2f5;
            color: #666;
            margin-right: 10px;
        }

        .edit-modal-footer .save-btn {
            background-color: var(--primary-color);
            color: white;
        }

        /* Add these styles to your existing CSS */
        .popup {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .popup-content {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            position: relative;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .popup-body {
            max-height: calc(80vh - 100px);
            overflow-y: auto;
            padding-right: 10px;
        }

        .popup-body::-webkit-scrollbar {
            width: 8px;
        }

        .popup-body::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .popup-body::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        .popup-body::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .close-popup {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }

        .close-popup:hover {
            color: #333;
        }

        .popup h2 {
            color: var(--primary-color);
            margin-bottom: 20px;
            padding-right: 30px;
        }

        .popup h3 {
            color: var(--primary-color);
            margin: 20px 0 10px;
        }

        .popup p {
            margin-bottom: 15px;
            line-height: 1.6;
        }

        .popup .rules-list {
            list-style-type: none;
            padding: 0;
        }

        .popup .rules-list li {
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }

        .popup .rules-list li:last-child {
            border-bottom: none;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header>
        <div class="container header-container">
            <div class="logo">Confess<span>ly</span></div>
            <div class="auth-buttons">
                <button class="btn btn-secondary" onclick="showModal('loginModal')">Login</button>
                <button class="btn btn-primary" onclick="showModal('signupModal')">Sign Up</button>
            </div>
            <div class="profile-menu" style="display: none;">
                <button class="profile-button" onclick="toggleProfileDropdown()">
                    <div class="profile-info">
                        <span id="username" class="username">Username</span>
                    </div>
                    <i class="fas fa-chevron-down dropdown-arrow"></i>
                </button>
                <div class="profile-dropdown" id="profileDropdown">
                    <a href="#" class="profile-dropdown-item" onclick="editUsername()">
                        <i class="fas fa-user-edit"></i>
                        Edit Username
                    </a>
                    <div class="profile-dropdown-divider"></div>
                    <a href="#" class="profile-dropdown-item" onclick="confirmLogout()">
                        <i class="fas fa-sign-out-alt"></i>
                        Logout
                    </a>
                </div>
            </div>
        </div>
    </header>

    <!-- Hero Section -->
    <section class="hero">
        <div class="container">
            <h1>Share Your Thoughts Anonymously</h1>
            <p>Express yourself freely without revealing your identity. Connect, share, and engage with the community.</p>
            <button class="btn btn-primary" id="create-menfess-btn">Create Menfess</button>
        </div>
    </section>

    <!-- Main Content -->
    <div class="container main-content">
        <!-- Menfess Posts -->
        <div class="menfess-container">
            <div class="menfess-header">
                <h2>Menfess</h2>
                <div class="filters">
                    <div class="filter-item active" id="filter-all" onclick="showAllMenfess()">ALL</div>
                    <div class="filter-item" id="filter-popular" onclick="showPopularMenfess()">Popular</div>
                    <div class="filter-item" id="filter-my" onclick="showMyMenfess()">My Menfess</div>
                </div>
            </div>
            <div class="menfess-list">
                <!-- Menfess akan dimuat secara dinamis di sini -->
            </div>
        </div>

        <!-- Sidebar -->
        <div class="sidebar">
            <!-- Create New Menfess Form (Match Rules Card) -->
            <div class="sidebar-card">
                <div class="sidebar-header">Create New Menfess</div>
                <div class="sidebar-content">
                    <textarea id="menfessContent" placeholder="What's on your mind?"></textarea>
                    <button id="createMenfessBtn" onclick="createMenfess()">Post Menfess</button>
                </div>
            </div>

            <!-- Rules Card -->
            <div class="sidebar-card">
                <div class="sidebar-header">
                    Menfess Rules
                </div>
                <div class="sidebar-content">
                    <ul class="rules-list">
                        <li>
                            <i class="fas fa-check-circle"></i>
                            <div>Keep your messages respectful and kind</div>
                        </li>
                        <li>
                            <i class="fas fa-check-circle"></i>
                            <div>No hate speech, bullying, or harassment</div>
                        </li>
                        <li>
                            <i class="fas fa-check-circle"></i>
                            <div>No spamming or excessive posting</div>
                        </li>
                        <li>
                            <i class="fas fa-check-circle"></i>
                            <div>No sharing of personal information</div>
                        </li>
                        <li>
                            <i class="fas fa-check-circle"></i>
                            <div>Violations may result in account suspension</div>
                        </li>
                    </ul>
                </div>
            </div>
            <!-- Trending Topics Card -->
            <div class="sidebar-card">
                <div class="sidebar-header">Trending Topic</div>
                <div class="sidebar-content">
                    <div class="trending-topics" id="trendingTopics"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>Follow Us!</h3>
                    <div class="social-links">
                        <a href="https://www.instagram.com/confess_ly" target="_blank"><i class="fab fa-instagram"></i></a>
                        <a href="http://www.tiktok.com/@confess_ly" target="_blank"><i class="fab fa-tiktok"></i></a>
                    </div>
                </div>
                <div class="footer-section">
                    <h3>Quick Links</h3>
                    <ul class="footer-links">
                        <li><a href="#">Home</a></li>
                        <li><a href="#" onclick="showRulesPopup(); return false;">Rules</a></li>
                        <li><a href="#" onclick="showAboutPopup(); return false;">About Confessly</a></li>
                        <li><a href="#" onclick="showPrivacyPopup(); return false;">Privacy Policy</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h3>Contact Us</h3>
                    <ul class="footer-links">
                        <li><a href="mailto:info@confessly.id">info@confessly.id</a></li>
                        <li><a href="tel:+6281234567890">+62 812-3456-7890</a></li>
                    </ul>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2025 Confessly. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <!-- Login Modal -->
    <div id="loginModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal('loginModal')">&times;</span>
            <h2>Login</h2>
            <form id="loginForm" onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label for="loginUsername">Username</label>
                    <input type="text" id="loginUsername" required>
                </div>
                <div class="form-group">
                    <label for="loginPassword">Password</label>
                    <input type="password" id="loginPassword" required>
                </div>
                <div class="error-message" id="loginError"></div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Login</button>
                <div class="modal-footer">
                    <p>Don't have an account? <a onclick="showModal('signupModal'); closeModal('loginModal')">Sign up</a></p>
                </div>
            </form>
        </div>
    </div>

    <!-- Signup Modal -->
    <div id="signupModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal('signupModal')">&times;</span>
            <h2>Sign Up</h2>
            <form id="signupForm" onsubmit="handleSignup(event)">
                <div class="form-group">
                    <label for="signupUsername">Username</label>
                    <input type="text" id="signupUsername" required>
                </div>
                <div class="form-group">
                    <label for="signupPassword">Password</label>
                    <input type="password" id="signupPassword" required>
                </div>
                <div class="form-group">
                    <label for="confirmPassword">Confirm Password</label>
                    <input type="password" id="confirmPassword" required>
                </div>
                <div class="error-message" id="signupError"></div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Sign Up</button>
                <div class="modal-footer">
                    <p>Already have an account? <a onclick="showModal('loginModal'); closeModal('signupModal')">Login</a></p>
                </div>
            </form>
        </div>
    </div>

    <!-- Rules Modal -->
    <div id="rules-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Menfess Rules</h2>
                <span class="close-modal">&times;</span>
            </div>
            <div class="modal-body">
                <ul class="rules-list">
                    <li>
                        <i class="fas fa-check-circle"></i>
                        <div>Keep your messages respectful and kind</div>
                    </li>
                    <li>
                        <i class="fas fa-check-circle"></i>
                        <div>No hate speech, bullying, or harassment</div>
                    </li>
                    <li>
                        <i class="fas fa-check-circle"></i>
                        <div>No spamming or excessive posting</div>
                    </li>
                    <li>
                        <i class="fas fa-check-circle"></i>
                        <div>No sharing of personal information</div>
                    </li>
                    <li>
                        <i class="fas fa-check-circle"></i>
                        <div>Violations may result in account suspension</div>
                    </li>
                </ul>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary close-modal-btn">Close</button>
            </div>
        </div>
    </div>

    <!-- About Us Modal -->
    <div id="about-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">About Confessly</h2>
                <span class="close-modal">&times;</span>
            </div>
            <div class="modal-body">
                <div style="text-align: center; margin-bottom: 20px;">
                    <h3 style="color: var(--primary-color); margin-bottom: 15px;">Welcome to Confessly</h3>
                    <p style="line-height: 1.6; margin-bottom: 15px;">
                        Confessly is a platform designed to provide a safe and anonymous space for people to share their thoughts, feelings, and experiences. Our mission is to foster meaningful connections and open dialogue while maintaining user privacy and security.
                    </p>
                    <p style="line-height: 1.6; margin-bottom: 15px;">
                        Founded in 2025, Confessly has grown into a community where people can express themselves freely without fear of judgment. We believe in the power of anonymous sharing to create understanding and empathy among our users.
                    </p>
                    <p style="line-height: 1.6;">
                        Our team is dedicated to maintaining a positive and supportive environment for all users. We continuously work to improve our platform and ensure the best experience for our community.
                    </p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary close-modal-btn">Close</button>
            </div>
        </div>
    </div>

    <!-- Privacy Policy Modal -->
    <div id="privacy-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Privacy Policy</h2>
                <span class="close-modal">&times;</span>
            </div>
            <div class="modal-body">
                <h3>1. Information We Collect</h3>
                <p>We collect information that you provide directly to us, including when you create an account, post content, or communicate with other users.</p>
                
                <h3>2. How We Use Your Information</h3>
                <p>We use the information we collect to provide, maintain, and improve our services, to develop new features, and to protect Confessly and our users.</p>
                
                <h3>3. Information Sharing</h3>
                <p>We do not share your personal information with third parties except as described in this privacy policy.</p>
                
                <h3>4. Data Security</h3>
                <p>We take reasonable measures to help protect your personal information from loss, theft, misuse, unauthorized access, disclosure, alteration, and destruction.</p>
                
                <h3>5. Your Rights</h3>
                <p>You have the right to access, correct, or delete your personal information. You can also object to our processing of your personal information.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary close-modal-btn">Close</button>
            </div>
        </div>
    </div>

    <!-- Add Alert Modal -->
    <div id="alertModal" class="alert-modal">
        <div class="alert-content">
            <div class="alert-title" id="alertTitle">Alert</div>
            <div class="alert-message" id="alertMessage"></div>
            <div class="alert-buttons">
                <button class="alert-btn alert-btn-secondary" onclick="closeAlert()">Cancel</button>
                <button class="alert-btn alert-btn-primary" id="alertConfirmBtn">OK</button>
            </div>
        </div>
    </div>

    <!-- Add Edit Modal -->
    <div id="editModal" class="edit-modal">
        <div class="edit-modal-content">
            <div class="edit-modal-header">
                <h3>Edit Menfess</h3>
                <span class="edit-modal-close" onclick="closeEditModal()">&times;</span>
            </div>
            <div class="edit-modal-body">
                <textarea id="editMenfessContent"></textarea>
            </div>
            <div class="edit-modal-footer">
                <button class="cancel-btn" onclick="closeEditModal()">Cancel</button>
                <button class="save-btn" onclick="saveEdit()">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Add these popup divs before the closing body tag -->
    <div id="rulesPopup" class="popup">
        <div class="popup-content">
            <span class="close-popup" onclick="closePopup('rulesPopup')">&times;</span>
            <h2>Rules</h2>
            <div class="popup-body">
                <ul class="rules-list">
                    <li>Keep your messages respectful and kind</li>
                    <li>No hate speech, bullying, or harassment</li>
                    <li>No spamming or excessive posting</li>
                    <li>No sharing of personal information</li>
                    <li>Violations may result in account suspension</li>
                </ul>
            </div>
        </div>
    </div>

    <div id="aboutPopup" class="popup">
        <div class="popup-content">
            <span class="close-popup" onclick="closePopup('aboutPopup')">&times;</span>
            <h2>About Confessly</h2>
            <div class="popup-body">
                <p>Confessly is a platform designed to provide a safe and anonymous space for people to share their thoughts, feelings, and experiences. Our mission is to foster meaningful connections and open dialogue while maintaining user privacy and security.</p>
                <p>Founded in 2025, Confessly has grown into a community where people can express themselves freely without fear of judgment. We believe in the power of anonymous sharing to create understanding and empathy among our users.</p>
                <p>Our team is dedicated to maintaining a positive and supportive environment for all users. We continuously work to improve our platform and ensure the best experience for our community.</p>
            </div>
        </div>
    </div>

    <div id="privacyPopup" class="popup">
        <div class="popup-content">
            <span class="close-popup" onclick="closePopup('privacyPopup')">&times;</span>
            <h2>Privacy Policy</h2>
            <div class="popup-body">
                <h3>1. Information We Collect</h3>
                <p>We collect information that you provide directly to us, including when you create an account, post content, or communicate with other users.</p>
                
                <h3>2. How We Use Your Information</h3>
                <p>We use the information we collect to provide, maintain, and improve our services, to develop new features, and to protect Confessly and our users.</p>
                
                <h3>3. Information Sharing</h3>
                <p>We do not share your personal information with third parties except as described in this privacy policy.</p>
                
                <h3>4. Data Security</h3>
                <p>We take reasonable measures to help protect your personal information from loss, theft, misuse, unauthorized access, disclosure, alteration, and destruction.</p>
                
                <h3>5. Your Rights</h3>
                <p>You have the right to access, correct, or delete your personal information. You can also object to our processing of your personal information.</p>
            </div>
        </div>
    </div>

<script>
        // Deklarasi currentFilter di atas
        let currentFilter = 'all';
        let currentEditId = null;

    // DOM Elements
    const loginBtn = document.getElementById('login-btn');
    const signupBtn = document.getElementById('signup-btn');
        const loginModal = document.getElementById('loginModal');
        const signupModal = document.getElementById('signupModal');
    const closeModalBtns = document.querySelectorAll('.close-modal, .close-modal-btn');
    const createMenfessBtn = document.getElementById('create-menfess-btn');
    const newMenfessForm = document.querySelector('.new-menfess-form');
    const menfessList = document.querySelector('.menfess-list');
    const commentForms = document.querySelectorAll('.comment-form');
    const filterItems = document.querySelectorAll('.filter-item');

    // Modal Functions
        function showModal(modalId) {
            document.getElementById(modalId).style.display = 'flex';
    }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
    }

    // Event Listeners
        if (loginBtn) loginBtn.addEventListener('click', () => showModal('loginModal'));
        if (signupBtn) signupBtn.addEventListener('click', () => showModal('signupModal'));
        if (createMenfessBtn) createMenfessBtn.addEventListener('click', () => {
            const form = document.querySelector('.new-menfess-form');
            if (form) form.scrollIntoView({ behavior: 'smooth' });
        });
        if (closeModalBtns) closeModalBtns.forEach(btn => {
            if (btn) {
        btn.addEventListener('click', () => {
                    closeModal('loginModal');
                    closeModal('signupModal');
                });
            }
        });

        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }

    // API Functions
    async function fetchMenfess(filter = 'all') {
        try {
            const endpoint = filter === 'popular' ? '/api/menfess/popular' : '/api/menfess';
            const response = await fetch(endpoint);
            const data = await response.json();
            updateMenfessList(data);
        } catch (error) {
            console.error('Error saat mengambil menfess:', error);
        }
    }

        async function createMenfess() {
            const content = document.getElementById('menfessContent').value;
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            
            if (!currentUser) {
                showModal('loginModal');
                return;
            }

        try {
            const response = await fetch('/api/menfess', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                        username: currentUser.username,
                        password: currentUser.password,
                    content: content
                })
            });

            if (response.ok) {
                    // Clear the form and refresh the menfess list
                    document.getElementById('menfessContent').value = '';
                    loadMenfess();
                } else {
                    const error = await response.text();
                    if (error.includes("session has expired")) {
                        // Clear invalid session
                        localStorage.removeItem('currentUser');
                        showModal('loginModal');
                    }
                    alert(error);
            }
        } catch (error) {
                console.error('Error creating menfess:', error);
                alert('An error occurred while creating the menfess post.');
        }
    }

    async function likeMenfess(id) {
        const currentUser = JSON.parse(localStorage.getItem('currentUser'));
        if (!currentUser) {
            showModal('loginModal');
            return;
        }

        try {
            const response = await fetch(`/api/menfess/${id}/like`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    username: currentUser.username,
                    password: currentUser.password
                })
            });

            if (response.ok) {
                const result = await response.json();
                const likeElement = document.querySelector(`[data-menfess-id="${id}"] .post-action`);
                const likeCount = likeElement.querySelector('span');
                const heartIcon = likeElement.querySelector('i');

                // Update like count
                likeCount.textContent = `${result.likes} Likes`;

                // Update liked state
                if (result.liked) {
                    likeElement.classList.add('liked');
                    heartIcon.classList.remove('far');
                    heartIcon.classList.add('fas');
                } else {
                    likeElement.classList.remove('liked');
                    heartIcon.classList.remove('fas');
                    heartIcon.classList.add('far');
                }
            } else {
                const error = await response.text();
                if (error.includes("session has expired")) {
                    localStorage.removeItem('currentUser');
                    showModal('loginModal');
                }
                alert(error);
            }
        } catch (error) {
            console.error('Error liking menfess:', error);
            alert('An error occurred while liking the menfess.');
        }
    }

    async function addComment(menfessId, content) {
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            if (!currentUser) {
                showModal('loginModal');
                return;
            }

        try {
            const response = await fetch(`/api/menfess/${menfessId}/comment`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                        username: currentUser.username,
                        password: currentUser.password,
                    content: content
                })
            });

            if (response.ok) {
                    const result = await response.json();
                    // Clear the comment input
                    const commentInput = document.querySelector(`[data-menfess-id="${menfessId}"] .comment-input`);
                    if (commentInput) {
                        commentInput.value = '';
                    }
                    // Reload the menfess to show the new comment
                    loadMenfess();
                } else {
                    const error = await response.text();
                    if (error.includes("session has expired")) {
                        localStorage.removeItem('currentUser');
                        showModal('loginModal');
                    } else {
                        alert(error);
                    }
            }
        } catch (error) {
                console.error('Error adding comment:', error);
                alert('An error occurred while adding the comment.');
            }
        }

        function handleCommentSubmit(event, menfessId) {
            event.preventDefault();
            const form = event.target;
            const input = form.querySelector('.comment-input');
            const content = input.value.trim();
            
            if (content) {
                addComment(menfessId, content);
            }
        }

        function toggleComments(menfessId) {
            const commentsSection = document.querySelector(`[data-menfess-id="${menfessId}"] .comments-section`);
            if (commentsSection) {
                commentsSection.style.display = commentsSection.style.display === 'none' ? 'block' : 'none';
        }
    }

    // UI Update Functions
    function updateMenfessList(menfess) {
        if (!Array.isArray(menfess)) {
            console.error('Diharapkan array menfess, mendapatkan:', menfess);
            return;
        }
            
        const currentUser = JSON.parse(localStorage.getItem('currentUser'));
        
        menfessList.innerHTML = menfess.map(m => {
            const isLiked = currentUser && m.likedUserIds && m.likedUserIds.includes(currentUser.id);
            return `
                <div class="menfess-post" data-menfess-id="${m.id}">
                    <div class="post-header">
                        <span class="post-id">#M${m.id.toString().padStart(3, '0')}</span>
                        <span class="post-time">${formatTime(m.timestamp || m.createdAt || new Date())}</span>
                    </div>
                    <div class="post-content">
                        <p>${m.isi || m.content}</p>
                    </div>
                    <div class="post-actions">
                        <div class="post-action ${isLiked ? 'liked' : ''}" onclick="likeMenfess(${m.id})">
                            <i class="${isLiked ? 'fas' : 'far'} fa-heart"></i>
                            <span>${m.likes || 0} Likes</span>
                        </div>
                        <div class="post-action" onclick="toggleComments(${m.id})">
                            <i class="far fa-comment"></i>
                            <span>${(m.komentarList || []).length} Komentar</span>
                        </div>
                        ${currentUser && (currentUser.id === m.pengirim.id) ? `
                        <div class="post-action edit" onclick="showEditModal(${m.id}, '${(m.isi || '').replace(/'/g, "\\'")}')">
                            <i class="fas fa-edit"></i>
                            <span>Edit</span>
                        </div>
                        ` : ''}
                        ${currentUser && (currentUser.id === m.pengirim.id || currentUser.role === 'admin') ? `
                        <div class="post-action delete" onclick="deleteMenfess(${m.id})">
                            <i class="fas fa-trash"></i>
                            <span>Delete</span>
                        </div>
                        ` : ''}
                    </div>
                    <div class="comments-section" style="display: none;">
                        ${(m.komentarList || []).map(c => {
                            const isCommentLiked = currentUser && c.likedUserIds && c.likedUserIds.includes(currentUser.id);
                            return `
                                <div class="comment" data-comment-id="${c.id}">
                                    <div class="comment-header">
                                        <span class="comment-user">@${c.pengirim?.username || 'anonymous'}</span>
                                        <span class="comment-time">${formatTime(c.timestamp || c.createdAt || new Date())}</span>
                                    </div>
                                    <div class="comment-text">${c.isi || c.content}</div>
                                    <div class="comment-actions">
                                        <div class="comment-action ${isCommentLiked ? 'liked' : ''}" onclick="likeComment(${c.id})">
                                            <i class="${isCommentLiked ? 'fas' : 'far'} fa-heart"></i>
                                            <span>${c.likes || 0} Likes</span>
                                        </div>
                                        ${currentUser && (currentUser.id === c.pengirim?.id || currentUser.role === 'admin') ? `
                                        <div class="comment-action delete" onclick="deleteComment(${c.id})">
                                            <i class="fas fa-trash"></i>
                                            <span>Delete</span>
                                        </div>
                                        ` : ''}
                                    </div>
                                </div>
                            `;
                        }).join('')}
                        <form class="comment-form" onsubmit="handleCommentSubmit(event, ${m.id})">
                            <input type="text" class="comment-input" placeholder="Tulis komentar...">
                            <button type="submit" class="comment-submit">Kirim</button>
                        </form>
                    </div>
                </div>
            `;
        }).join('');
    }

    async function likeComment(id) {
        const currentUser = JSON.parse(localStorage.getItem('currentUser'));
        if (!currentUser) {
            showModal('loginModal');
            return;
        }

        try {
            const response = await fetch(`/api/comment/${id}/like`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    username: currentUser.username,
                    password: currentUser.password
                })
            });

            if (response.ok) {
                const result = await response.json();
                const likeElement = document.querySelector(`[data-comment-id="${id}"] .comment-action`);
                const likeCount = likeElement.querySelector('span');
                const heartIcon = likeElement.querySelector('i');

                // Update like count
                likeCount.textContent = `${result.likes} Likes`;

                // Update liked state
                if (result.liked) {
                    likeElement.classList.add('liked');
                    heartIcon.classList.remove('far');
                    heartIcon.classList.add('fas');
                } else {
                    likeElement.classList.remove('liked');
                    heartIcon.classList.remove('fas');
                    heartIcon.classList.add('far');
                }
            } else {
                const error = await response.text();
                if (error.includes("session has expired")) {
                    localStorage.removeItem('currentUser');
                    showModal('loginModal');
                }
                alert(error);
            }
        } catch (error) {
            console.error('Error liking comment:', error);
            alert('An error occurred while liking the comment.');
        }
    }

    function updateLikeCount(id, likes) {
        const likeElement = document.querySelector(`[data-menfess-id="${id}"] .post-action span`);
        if (likeElement) {
            likeElement.textContent = `${likes} Likes`;
        }
    }

    function formatTime(timestamp) {
        const date = new Date(timestamp);
        const now = new Date();
        const diff = now - date;
        
        const minutes = Math.floor(diff / 60000);
        const hours = Math.floor(minutes / 60);
        const days = Math.floor(hours / 24);

        if (minutes < 60) return `${minutes} minutes ago`;
        if (hours < 24) return `${hours} hours ago`;
        return `${days} days ago`;
    }

    // Form Handlers
    newMenfessForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const content = document.getElementById('menfess-content').value;
        if (content.trim()) {
            await createMenfess(content);
        }
    });

    // Filter Functions
    function setupFilters() {
        filterItems.forEach(item => {
            item.addEventListener('click', () => {
                // Menghapus kelas aktif dari semua filter
                filterItems.forEach(fi => fi.classList.remove('active'));
                // Menambahkan kelas aktif ke filter yang diklik
                item.classList.add('active');
                
                // Mengambil menfess berdasarkan filter
                const filter = item.textContent.toLowerCase();
                fetchMenfess(filter);
            });
        });
    }

    // Inisialisasi
    document.addEventListener('DOMContentLoaded', () => {
        setupFilters();
        fetchMenfess();
        fetchTrendingHashtags();
    });

    // Mengambil hashtag trending
    async function fetchTrendingHashtags() {
        try {
            const response = await fetch('/api/menfess/trending');
            const hashtags = await response.json();
            updateTrendingTopics(hashtags);
        } catch (error) {
            console.error('Error saat mengambil hashtag trending:', error);
        }
    }

    // Memperbarui topik trending di UI
    function updateTrendingTopics(hashtags) {
        const trendingTopicsContainer = document.querySelector('.trending-topics');
        if (hashtags.length === 0) {
            trendingTopicsContainer.innerHTML = '<div class="no-trends">Belum ada topik trending</div>';
            return;
        }
        
        trendingTopicsContainer.innerHTML = hashtags.map(hashtag => 
            `<div class="topic-tag" onclick="filterByHashtag('${hashtag}')">${hashtag}</div>`
        ).join('');
    }

    // Filter post berdasarkan hashtag
    function filterByHashtag(hashtag) {
        const posts = document.querySelectorAll('.menfess-post');
        posts.forEach(post => {
            const content = post.querySelector('.post-content').textContent.toLowerCase();
            if (content.includes(hashtag.toLowerCase())) {
                post.style.display = 'block';
            } else {
                post.style.display = 'none';
            }
        });
    }

    // Additional Modal Elements
    const rulesModal = document.getElementById('rules-modal');
    const aboutModal = document.getElementById('about-modal');
    const privacyModal = document.getElementById('privacy-modal');

    // Update footer links to open modals
    document.querySelector('a[href="#rules"]').addEventListener('click', (e) => {
        e.preventDefault();
            showModal('rules-modal');
    });

    document.querySelector('a[href="#about-confessly"]').addEventListener('click', (e) => {
        e.preventDefault();
            showModal('about-modal');
    });

    document.querySelector('a[href="#privacy-policy"]').addEventListener('click', (e) => {
        e.preventDefault();
            showModal('privacy-modal');
        });

        // Handle Login
        async function handleLogin(event) {
            event.preventDefault();
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            const errorElement = document.getElementById('loginError');

            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, password })
                });

                if (response.ok) {
                    const user = await response.json();
                    // Store both user data and password
                    const userData = {
                        ...user,
                        password: password // Store password for future requests
                    };
                    localStorage.setItem('currentUser', JSON.stringify(userData));
                    closeModal('loginModal');
                    // Enable menfess creation
                    document.getElementById('create-menfess-btn').disabled = false;
                    updateProfileDisplay();
                } else {
                    const error = await response.text();
                    errorElement.textContent = error;
                    errorElement.style.display = 'block';
                }
            } catch (error) {
                errorElement.textContent = 'An error occurred. Please try again.';
                errorElement.style.display = 'block';
            }
        }

        // Handle Signup
        async function handleSignup(event) {
            event.preventDefault();
            const username = document.getElementById('signupUsername').value.trim();
            const password = document.getElementById('signupPassword').value.trim();
            const confirmPassword = document.getElementById('confirmPassword').value.trim();
            const errorElement = document.getElementById('signupError');

            if (!username || !password) {
                errorElement.textContent = 'Username and password are required';
                errorElement.style.display = 'block';
                return;
            }
            if (password !== confirmPassword) {
                errorElement.textContent = 'Passwords do not match';
                errorElement.style.display = 'block';
                return;
            }

            try {
                const response = await fetch('/api/auth/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, password })
                });

                if (response.ok) {
                    const user = await response.json();
                    // Store both user data and password
                    const userData = {
                        ...user,
                        password: password // Store password for future requests
                    };
                    localStorage.setItem('currentUser', JSON.stringify(userData));
                    closeModal('signupModal');
                    // Enable menfess creation
                    document.getElementById('create-menfess-btn').disabled = false;
                    updateProfileDisplay();
                } else {
                    const error = await response.text();
                    errorElement.textContent = error;
                    errorElement.style.display = 'block';
                }
            } catch (error) {
                errorElement.textContent = 'An error occurred. Please try again.';
                errorElement.style.display = 'block';
            }
        }

        // Check authentication before creating menfess
        function checkAuthBeforeMenfess() {
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            if (!currentUser) {
                showModal('loginModal');
                return false;
            }
            return true;
        }

        function setActiveFilter(filter) {
            document.querySelectorAll('.filter-item').forEach(el => el.classList.remove('active'));
            const filterEl = document.getElementById('filter-' + filter);
            if (filterEl) filterEl.classList.add('active');
            currentFilter = filter;
        }

        function showAllMenfess() {
            setActiveFilter('all');
            loadMenfess('/api/menfess', false);
        }

        function showPopularMenfess() {
            setActiveFilter('popular');
            fetch('/api/menfess/popular?ts=' + Date.now(), { cache: 'reload' })
                .then(res => res.json())
                .then(data => {
                    renderMenfessList(data); // Tidak ada sorting ulang di sini!
                });
        }

        function showMyMenfess() {
            setActiveFilter('my');
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            if (!currentUser) {
                showModal('loginModal');
                return;
            }
            loadMenfess('/api/menfess/my?username=' + encodeURIComponent(currentUser.username));
        }

        // Update the loadMenfess function to handle the popular filter
        async function loadMenfess(url = '/api/menfess', debug = false) {
            try {
                const response = await fetch(url, { cache: 'reload' });
                if (!response.ok) {
                    throw new Error('Failed to load menfess');
                }
                let data = await response.json();
                console.log('Received menfess data:', data); // Log tambahan untuk debugging
                // Fallback: Sorting di frontend jika filter populer
                if (url.includes('/popular')) {
                    data = data.sort((a, b) => {
                        const scoreA = ((a.likes || 0) * 2) + ((a.komentarList && a.komentarList.length) || 0);
                        const scoreB = ((b.likes || 0) * 2) + ((b.komentarList && b.komentarList.length) || 0);
                        if (scoreB !== scoreA) return scoreB - scoreA;
                        // Jika skor sama, urutkan berdasarkan timestamp terbaru
                        return new Date(b.timestamp || b.createdAt) - new Date(a.timestamp || a.createdAt);
                    });
                }
                if (debug) {
                    console.log('[POPULAR DATA FROM BACKEND]', data.map(m => ({
                        id: m.id,
                        likes: m.likes,
                        komentar: m.komentarList ? m.komentarList.length : 0,
                        score: (m.likes * 2) + (m.komentarList ? m.komentarList.length : 0)
                    })));
                }
                const list = document.querySelector('.menfess-list');
                if (!list) return;

                const currentUser = JSON.parse(localStorage.getItem('currentUser'));
                console.log('Current user from localStorage in loadMenfess:', currentUser); // Log tambahan
                
                list.innerHTML = data.map(m => {
                    console.log('Processing individual menfess:', m); // Log tambahan
                    const isLiked = currentUser && m.likedUserIds && m.likedUserIds.includes(currentUser.id);
                    return `
                        <div class="menfess-post" data-menfess-id="${m.id}">
                            <div class="post-header">
                                <span class="post-id">#M${m.id.toString().padStart(3, '0')}</span>
                                <span class="post-time">${formatTime(m.timestamp || m.createdAt || new Date())}</span>
                            </div>
                            <div class="post-content">
                                <p>${m.isi || m.content}</p>
                            </div>
                            <div class="post-actions">
                                <div class="post-action ${isLiked ? 'liked' : ''}" onclick="likeMenfess(${m.id})">
                                    <i class="${isLiked ? 'fas' : 'far'} fa-heart"></i>
                                    <span>${m.likes || 0} Likes</span>
                                </div>
                                <div class="post-action" onclick="toggleComments(${m.id})">
                                    <i class="far fa-comment"></i>
                                    <span>${(m.komentarList || []).length} Komentar</span>
                                </div>
                                ${currentUser && (currentUser.id === m.pengirim.id) ? `
                                <div class="post-action edit" onclick="showEditModal(${m.id}, '${(m.isi || '').replace(/'/g, "\\'")}')">
                                    <i class="fas fa-edit"></i>
                                    <span>Edit</span>
                                </div>
                                ` : ''}
                                ${currentUser && (currentUser.id === m.pengirim.id || currentUser.role === 'admin') ? `
                                <div class="post-action delete" onclick="deleteMenfess(${m.id})">
                                    <i class="fas fa-trash"></i>
                                    <span>Delete</span>
                                </div>
                                ` : ''}
                            </div>
                            <div class="comments-section" style="display: none;">
                                ${(m.komentarList || []).map(c => {
                                    console.log('Processing individual comment:', c); // Log tambahan
                                    const isCommentLiked = currentUser && c.likedUserIds && c.likedUserIds.includes(currentUser.id);
                                    return `
                                        <div class="comment" data-comment-id="${c.id}">
                                            <div class="comment-header">
                                                <span class="comment-user">@${c.pengirim?.username || 'anonymous'}</span>
                                                <span class="comment-time">${formatTime(c.timestamp || c.createdAt || new Date())}</span>
                                            </div>
                                            <div class="comment-text">${c.isi || c.content}</div>
                                            <div class="comment-actions">
                                                <div class="comment-action ${isCommentLiked ? 'liked' : ''}" onclick="likeComment(${c.id})">
                                                    <i class="${isCommentLiked ? 'fas' : 'far'} fa-heart"></i>
                                                    <span>${c.likes || 0} Likes</span>
                                                </div>
                                                ${currentUser && (currentUser.id === c.pengirim?.id || currentUser.role === 'admin') ? `
                                                <div class="comment-action delete" onclick="deleteComment(${c.id})">
                                                    <i class="fas fa-trash"></i>
                                                    <span>Delete</span>
                                                </div>
                                                ` : ''}
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                                <form class="comment-form" onsubmit="handleCommentSubmit(event, ${m.id})">
                                    <input type="text" class="comment-input" placeholder="Tulis komentar...">
                                    <button type="submit" class="comment-submit">Kirim</button>
                                </form>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading menfess:', error);
                alert('Failed to load menfess. Please try again later.');
            }
        }

        // Trending Topic
        async function loadTrendingTopics() {
            const res = await fetch('/api/menfess/trending');
            const hashtags = await res.json();
            const container = document.getElementById('trendingTopics');
            container.innerHTML = hashtags.map(tag => `<span class="topic-tag">${tag}</span>`).join('');
        }

        function updateProfileDisplay() {
            const user = JSON.parse(localStorage.getItem('currentUser'));
            const profileMenu = document.querySelector('.profile-menu');
            const authButtons = document.querySelector('.auth-buttons');
            
            if (user) {
                // Update username
                document.getElementById('username').textContent = user.username;
                
                // Show profile menu, hide auth buttons
                profileMenu.style.display = 'block';
                authButtons.style.display = 'none';
            } else {
                // Hide profile menu, show auth buttons
                profileMenu.style.display = 'none';
                authButtons.style.display = 'flex';
            }
        }

        function confirmLogout() {
            showAlert(
                'Confirm Logout',
                'Are you sure you want to logout?',
                () => logout()
            );
        }

        function logout() {
            localStorage.removeItem('currentUser');
            updateProfileDisplay();
            location.reload();
        }

        window.onload = function() {
            updateProfileDisplay();
            loadTrendingTopics();
            showAllMenfess();
        };

        function toggleProfileDropdown() {
            const dropdown = document.querySelector('.profile-dropdown');
            dropdown.classList.toggle('show');
        }

        // Close dropdown when clicking outside
        window.addEventListener('click', function(event) {
            const profileMenu = document.querySelector('.profile-menu');
            const dropdown = document.querySelector('.profile-dropdown');
            if (!profileMenu.contains(event.target)) {
                dropdown.classList.remove('show');
            }
        });

        function editUsername() {
            const newUsername = prompt('Enter new username:');
            if (newUsername) {
                const currentUser = JSON.parse(localStorage.getItem('currentUser'));
                
                fetch(`/api/profile/username?userId=${currentUser.id}&newUsername=${encodeURIComponent(newUsername)}`, {
                    method: 'PUT'
                })
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    }
                    throw new Error('Username update failed');
                })
                .then(updatedUser => {
                    localStorage.setItem('currentUser', JSON.stringify(updatedUser));
                    document.getElementById('username').textContent = updatedUser.username;
                    showAlert('Success', 'Username updated successfully!');
                })
                .catch(error => {
                    showAlert('Error', error.message);
                });
            }
        }

        function showAlert(title, message, onConfirm) {
            const modal = document.getElementById('alertModal');
            const titleEl = document.getElementById('alertTitle');
            const messageEl = document.getElementById('alertMessage');
            const confirmBtn = document.getElementById('alertConfirmBtn');
            
            titleEl.textContent = title;
            messageEl.textContent = message;
            
            // Set up confirm button
            confirmBtn.onclick = () => {
                closeAlert();
                if (onConfirm) onConfirm();
            };
            
            modal.style.display = 'flex';
        }

        function closeAlert() {
            const modal = document.getElementById('alertModal');
            modal.style.display = 'none';
        }

        // Fungsi untuk render daftar menfess
        function renderMenfessList(data) {
            const list = document.querySelector('.menfess-list');
            if (!list) return;
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            list.innerHTML = data.map(m => {
                const isLiked = currentUser && m.likedUserIds && m.likedUserIds.includes(currentUser.id);
                return `
                    <div class="menfess-post" data-menfess-id="${m.id}">
                        <div class="post-header">
                            <span class="post-id">#M${m.id.toString().padStart(3, '0')}</span>
                            <span class="post-time">${formatTime(m.timestamp || m.createdAt || new Date())}</span>
                        </div>
                        <div class="post-content">
                            <p>${m.isi || m.content}</p>
                        </div>
                        <div class="post-actions">
                            <div class="post-action ${isLiked ? 'liked' : ''}" onclick="likeMenfess(${m.id})">
                                <i class="${isLiked ? 'fas' : 'far'} fa-heart"></i>
                                <span>${m.likes || 0} Likes</span>
                            </div>
                            <div class="post-action" onclick="toggleComments(${m.id})">
                                <i class="far fa-comment"></i>
                                <span>${(m.komentarList || []).length} Komentar</span>
                            </div>
                            ${currentUser && (currentUser.id === m.pengirim.id) ? `
                            <div class="post-action edit" onclick="showEditModal(${m.id}, '${(m.isi || '').replace(/'/g, "\\'")}')">
                                <i class="fas fa-edit"></i>
                                <span>Edit</span>
                            </div>
                            ` : ''}
                            ${currentUser && (currentUser.id === m.pengirim.id || currentUser.role === 'admin') ? `
                            <div class="post-action delete" onclick="deleteMenfess(${m.id})">
                                <i class="fas fa-trash"></i>
                                <span>Delete</span>
                            </div>
                            ` : ''}
                        </div>
                        <div class="comments-section" style="display: none;">
                            ${(m.komentarList || []).map(c => {
                                const isCommentLiked = currentUser && c.likedUserIds && c.likedUserIds.includes(currentUser.id);
                                return `
                                    <div class="comment" data-comment-id="${c.id}">
                                        <div class="comment-header">
                                            <span class="comment-user">@${c.pengirim?.username || 'anonymous'}</span>
                                            <span class="comment-time">${formatTime(c.timestamp || c.createdAt || new Date())}</span>
                                        </div>
                                        <div class="comment-text">${c.isi || c.content}</div>
                                        <div class="comment-actions">
                                            <div class="comment-action ${isCommentLiked ? 'liked' : ''}" onclick="likeComment(${c.id})">
                                                <i class="${isCommentLiked ? 'fas' : 'far'} fa-heart"></i>
                                                <span>${c.likes || 0} Likes</span>
                                            </div>
                                            ${currentUser && (currentUser.id === c.pengirim?.id || currentUser.role === 'admin') ? `
                                            <div class="comment-action delete" onclick="deleteComment(${c.id})">
                                                <i class="fas fa-trash"></i>
                                                <span>Delete</span>
                                            </div>
                                            ` : ''}
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                            <form class="comment-form" onsubmit="handleCommentSubmit(event, ${m.id})">
                                <input type="text" class="comment-input" placeholder="Tulis komentar...">
                                <button type="submit" class="comment-submit">Kirim</button>
                            </form>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function deleteMenfess(id) {
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            if (!currentUser) {
                showModal('loginModal');
                return;
            }

            if (!confirm('Are you sure you want to delete this menfess?')) {
                return;
            }

            try {
                const response = await fetch(`/api/menfess/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(currentUser)
                });

                if (response.ok) {
                    // Remove the menfess post from the DOM
                    const menfessElement = document.querySelector(`[data-menfess-id="${id}"]`);
                    if (menfessElement) {
                        menfessElement.remove();
                    }
                } else {
                    const error = await response.text();
                    if (error.includes("session has expired")) {
                        localStorage.removeItem('currentUser');
                        showModal('loginModal');
                    }
                    alert(error);
                }
            } catch (error) {
                console.error('Error deleting menfess:', error);
                alert('An error occurred while deleting the menfess.');
            }
        }

        async function deleteComment(id) {
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            if (!currentUser) {
                showModal('loginModal');
                return;
            }

            if (!confirm('Are you sure you want to delete this comment?')) {
                return;
            }

            try {
                const response = await fetch(`/api/comment/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(currentUser)
                });

                if (response.ok) {
                    // Remove the comment from the DOM
                    const commentElement = document.querySelector(`[data-comment-id="${id}"]`);
                    if (commentElement) {
                        commentElement.remove();
                    }
                    loadMenfess(); // Reload menfess to update comment counts
                } else {
                    const error = await response.text();
                    if (error.includes("session has expired")) {
                        localStorage.removeItem('currentUser');
                        showModal('loginModal');
                    }
                    alert(error);
                }
            } catch (error) {
                console.error('Error deleting comment:', error);
                alert('An error occurred while deleting the comment.');
            }
        }

        function showEditModal(id, content) {
            currentEditId = id;
            const modal = document.getElementById('editModal');
            const textarea = document.getElementById('editMenfessContent');
            textarea.value = content;
            modal.style.display = 'block';
        }

        function closeEditModal() {
            const modal = document.getElementById('editModal');
            modal.style.display = 'none';
            currentEditId = null;
        }

        async function saveEdit() {
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            if (!currentUser) {
                showModal('loginModal');
                return;
            }

            const content = document.getElementById('editMenfessContent').value.trim();
            if (!content) {
                alert('Content cannot be empty');
                return;
            }

            try {
                const response = await fetch(`/api/menfess/${currentEditId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        username: currentUser.username,
                        password: currentUser.password,
                        content: content
                    })
                });

                if (response.ok) {
                    const updatedMenfess = await response.json();
                    // Update the content in the DOM
                    const contentElement = document.querySelector(`[data-menfess-id="${currentEditId}"] .post-content p`);
                    if (contentElement) {
                        contentElement.textContent = updatedMenfess.isi || updatedMenfess.content;
                    }
                    closeEditModal();
                } else {
                    const error = await response.text();
                    if (error.includes("session has expired")) {
                        localStorage.removeItem('currentUser');
                        showModal('loginModal');
                    }
                    alert(error);
                }
            } catch (error) {
                console.error('Error editing menfess:', error);
                alert('An error occurred while editing the menfess.');
            }
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const editModal = document.getElementById('editModal');
            if (event.target === editModal) {
                closeEditModal();
            }
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }

    // Add these functions to your existing JavaScript
    function showRulesPopup() {
        document.getElementById('rulesPopup').style.display = 'flex';
    }

    function showAboutPopup() {
        document.getElementById('aboutPopup').style.display = 'flex';
    }

    function showPrivacyPopup() {
        document.getElementById('privacyPopup').style.display = 'flex';
    }

    function closePopup(popupId) {
        document.getElementById(popupId).style.display = 'none';
    }

    // Close popup when clicking outside
    window.onclick = function(event) {
        if (event.target.classList.contains('popup')) {
            event.target.style.display = 'none';
        }
    }
</script>
</body>
</html> 